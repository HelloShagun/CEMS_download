# -*- coding: utf-8 -*-
"""
Created on Fri Aug 15 01:58:34 2025

@author: sg2009
"""

#!/usr/bin/env python3
"""
Simple web scraper for EMSR706 download page
Just gets all the download links from the JavaScript page
"""

import time
import requests
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import json
import os
from pathlib import Path

def scrape_emsr706_downloads():
    """Scrape the EMSR706 download page and find all download links"""

    url = "https://rapidmapping.emergency.copernicus.eu/EMSR829/download"

    # Setup Chrome options
    chrome_options = Options()
    chrome_options.add_argument('--headless')  # Run in background
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.add_argument('--window-size=1920,1080')

    print(f"Loading page: {url}")

    try:
        # Create driver
        driver = webdriver.Chrome(options=chrome_options)

        # Load the page
        driver.get(url)

        # Wait for page to load (adjust time as needed)
        print("Waiting for page to load...")
        time.sleep(10)  # Let JavaScript render

        # Get page source after JavaScript execution
        page_source = driver.page_source

        # Look for download links in various ways
        downloads = []

        # Method 1: Find all links
        print("Looking for download links...")
        links = driver.find_elements(By.TAG_NAME, "a")

        for link in links:
            href = link.get_attribute('href')
            text = link.text.strip()
            title = link.get_attribute('title')

            if href and any(ext in href.lower() for ext in ['.zip', '.pdf', '.shp', '.kml', '.json']):
                downloads.append({
                    'url': href,
                    'text': text,
                    'title': title,
                    'type': 'link'
                })
                print(f"Found link: {href}")

        # Method 2: Look for buttons that might trigger downloads
        print("Looking for download buttons...")
        buttons = driver.find_elements(By.TAG_NAME, "button")

        for button in buttons:
            text = button.text.strip().lower()
            onclick = button.get_attribute('onclick')
            data_url = button.get_attribute('data-url')

            if any(keyword in text for keyword in ['download', 'export', 'get']):
                downloads.append({
                    'element': 'button',
                    'text': button.text.strip(),
                    'onclick': onclick,
                    'data_url': data_url,
                    'type': 'button'
                })
                print(f"Found button: {button.text.strip()}")

        # Method 3: Look in page source for URLs
        print("Looking in page source...")
        import re

        # Look for ZIP URLs
        zip_urls = re.findall(r'https?://[^\s"\'<>]+\.zip', page_source)
        for url in zip_urls:
            if url not in [d['url'] for d in downloads if 'url' in d]:
                downloads.append({
                    'url': url,
                    'text': 'Found in page source',
                    'type': 'source'
                })
                print(f"Found in source: {url}")

        # Method 4: Look for API calls or AJAX endpoints
        api_patterns = [
            r'https?://[^\s"\'<>]+/api/[^\s"\'<>]+',
            r'https?://[^\s"\'<>]+/export[^\s"\'<>]*',
            r'https?://[^\s"\'<>]+/download[^\s"\'<>]*'
        ]

        for pattern in api_patterns:
            api_urls = re.findall(pattern, page_source)
            for url in api_urls:
                downloads.append({
                    'url': url,
                    'text': 'API endpoint found',
                    'type': 'api'
                })
                print(f"Found API: {url}")


        # Save results
        results = {
            'url_scraped': url,
            'scrape_time': time.strftime('%Y-%m-%d %H:%M:%S'),
            'total_downloads_found': len(downloads),
            'downloads': downloads,
            'page_title': driver.title,
            'page_source_length': len(page_source)
        }

        # Save to file
        output_file = Path('emsr706_scrape_results.json')
        with open(output_file, 'w') as f:
            json.dump(results, f, indent=2)

        print(f"\nResults saved to: {output_file}")
        print(f"Total downloads found: {len(downloads)}")

        # Print summary
        print("\n=== DOWNLOAD LINKS FOUND ===")
        for i, download in enumerate(downloads, 1):
            print(f"{i}. Type: {download['type']}")
            if 'url' in download:
                print(f"   URL: {download['url']}")
            if 'text' in download:
                print(f"   Text: {download['text']}")
            print()

        driver.quit()
        return downloads

    except Exception as e:
        print(f"Error: {e}")
        try:
            driver.quit()
        except:
            pass
        return []

def download_file(url, filename=None):
    """Download a file from URL"""
    if not filename:
        filename = os.path.basename(url)

    print(f"Downloading: {url}")

    try:
        response = requests.get(url, stream=True)
        response.raise_for_status()

        with open(filename, 'wb') as f:
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)

        print(f"Downloaded: {filename}")
        return True

    except Exception as e:
        print(f"Error downloading {url}: {e}")
        return False

def main():
    """Main function"""
    print("EMSR706 Web Scraper")
    print("=" * 50)

    # Scrape the page
    downloads = scrape_emsr706_downloads()

    if not downloads:
        print("No downloads found!")
        return

    # Find the "DOWNLOAD ALL PRODUCTS" button
    download_all_button = None
    for download in downloads:
        if download.get('type') == 'button' and download.get('text') == 'DOWNLOAD ALL PRODUCTS':
            download_all_button = download
            break

    if not download_all_button:
        print("DOWNLOAD ALL PRODUCTS button not found!")
        return

    # Attempt to click the button
    print("\nAttempting to click 'DOWNLOAD ALL PRODUCTS' button...")
    url = "https://rapidmapping.emergency.copernicus.eu/EMSR829/download"
    chrome_options = Options()
    chrome_options.add_argument('--headless')
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.add_argument('--window-size=1920,1080')

    driver = webdriver.Chrome(options=chrome_options)
    driver.get(url)
    time.sleep(10) # Wait for page to load

    try:
        # Find the button element again using its text
        buttons = driver.find_elements(By.TAG_NAME, "button")
        target_button = None
        for button in buttons:
            if button.text.strip() == 'DOWNLOAD ALL PRODUCTS':
                target_button = button
                break

        if target_button:
            driver.execute_script("arguments[0].click();", target_button)
            print("'DOWNLOAD ALL PRODUCTS' button clicked!")
            # You may need to add logic here to handle the download after clicking
            # This might involve waiting for a file to appear or checking for new URLs/windows
            time.sleep(5) # Give it a few seconds

            # Example: Check for new windows (if download opens a new tab)
            if len(driver.window_handles) > 1:
                driver.switch_to.window(driver.window_handles[-1])
                print(f"Switched to new window with URL: {driver.current_url}")
                # Add logic to handle the new window (e.g., download from the new URL)
                driver.close()
                driver.switch_to.window(driver.window_handles[0])

        else:
            print("'DOWNLOAD ALL PRODUCTS' button element not found on the page after reload.")

    except Exception as e:
        print(f"Error clicking button: {e}")
    finally:
        driver.quit()

if __name__ == "__main__":
    main()
